---
title: "Project"
author: "Smit Patil"
output: pdf_document
---

1. Data Acquisition

```{r warning=FALSE, message=FALSE}
#Reading both the airline survey data
airline.data_1 <- read.csv("passenger_survey_data_1.csv", stringsAsFactors = T)
airline.data_2 <- read.csv("passenger_survey_data_2.csv", stringsAsFactors = T)

#Binding both the airline survey data into a single data frame
airline.data <- rbind(airline.data_1, airline.data_2)

#Looking at the head and the structure of the airline data
head(airline.data)
str(airline.data)

#Removing column 1: x and column 2: id, as they are redundant for this application
airline.data <- airline.data[,-(1:2)]

#Printing the summary of the airline data
summary(airline.data)
```

2. Data Exploration

```{r warning=FALSE, message=FALSE}
#Importing libraries to calculate outliers and plot the correlation graph
library(ggplot2)
library(hrbrthemes)
library(viridis)
library(corrplot)
library(GGally)

#Looking for any NA values present in the dataset
anyNA(airline.data)

#Finding the column names which have NA values present in them
colnames(airline.data)[colSums(is.na(airline.data)) > 0]

#Using for loop to print histograms of airline data
for(i in 1:ncol(airline.data))
  {
    sprintf("Histogram for: ", colnames(airline.data[i]))
    hist((as.numeric(airline.data[,i])), xlab = colnames(airline.data[i]), col = 'steelblue1', main = NULL)
 }

#Plotting log transformed histogram for "Flight Distance", "Departure Delay", and "Arrival Delay"
#as they are Rigt Skewed
for (i in c("Flight.Distance", "Departure.Delay.in.Minutes", "Arrival.Delay.in.Minutes"))
  {
    hist(log(airline.data[,i]), col = "steelblue4", main = "Log Transformed", xlab = i)
  }

#Plotting a boxplot for the "Age" column in the airline data
airline.data %>%
  ggplot( aes(x=NULL, y=Age)) +
    geom_boxplot() +
    theme_ipsum() +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("Boxplot") +
    xlab("Value")

#Creating a data frame to calculate outliers for continious variables
airline.outliers <- airline.data[,c("Flight.Distance", "Departure.Delay.in.Minutes", "Arrival.Delay.in.Minutes")]

#Looking for outliers in the continious variable columns
for (i in c("Flight.Distance", "Departure.Delay.in.Minutes", "Arrival.Delay.in.Minutes"))
  {
    mean_data <- mean(airline.outliers[,i], na.rm = T)
    sd_data <- sd(airline.outliers[,i], na.rm = T)
    zscore <- abs((airline.outliers[,i] - mean_data)/sd_data)
    airline.outliers[,i] <- zscore
  }

#Setting non outlier values to NA to retrive the outliers
airline.outliers[airline.outliers<3] <- NA
outliers <- airline.outliers[rowSums(is.na(airline.outliers)) != ncol(airline.outliers), ]

#Viewing the outliers
head(outliers)

#Converting factor columns in airline data to numeric
for (i in 1:ncol(airline.data)-1)
  {
    if(is.factor(airline.data[,i]))
      {
        airline.data[,i] <- as.numeric(airline.data[,i])
      }
  }

#Plotting correlation plot for the airline data
correlation <- cor(na.omit(airline.data[,-23]))
corrplot(correlation, method = "color", type = "lower", col.text = "black", number.cex = .7, tl.col = "black", tl.srt = 45)

#Subsetting the highly correlated variables into a new data frame
selected_features <- airline.data[,c("Departure.Delay.in.Minutes", "Arrival.Delay.in.Minutes")]

#Plotting correlation graph for highly correlated variables
ggpairs(selected_features, columnLabels = c("Departure Delay", "Arrival Delay"))
```

3. Data Cleaning and Shaping

```{r warning=F, message=F}
#Importing Libraries to perform data cleaning
library(tidyverse)
library(arules)
library(stats)
library(factoextra)

#Creating a copy of airline data for data cleaning purpose
passenger.data <- airline.data

#Removing outliers from the passenger data
#passenger.data <- passenger.data[-as.numeric(row.names(outliers)), ]

#Replacing NA values in "Arrival Delay" column with mean value of the column
passenger.data$Arrival.Delay.in.Minutes <- passenger.data$Arrival.Delay.in.Minutes %>% replace_na(mean(passenger.data$Arrival.Delay.in.Minutes, na.rm = T))

#Descretizing the "Age" column into 6 distinct bins
#passenger.data$Age <- discretize(passenger.data$Age, breaks = 6)

#Log transforming right skewed data
for (i in c("Flight.Distance", "Departure.Delay.in.Minutes", "Arrival.Delay.in.Minutes"))
  {
    passenger.data[,i] <- log(passenger.data[, i] + 1)
  }


#Converting factor columns to numeric
for (i in 1:ncol(passenger.data)-1)
  {
    if(is.factor(passenger.data[,i]))
      {
        passenger.data[,i] <- as.numeric(passenger.data[,i])
      }
  }

#Performing PCA on the dataset
passenger.pca <- prcomp(passenger.data[,-23], center = T, scale = T)

#Printing PC's and summary of the PC's
print(passenger.pca)
summary(passenger.pca)

#Plotting variance plot for the first 10 PC's
screeplot(passenger.pca, type = "l", main = "Plot of the first 10 PCs") +
abline(h = 1, col="red", lty=5)

#Plotting scatter plot for the satisfaction levels from the calculated values of PC's
fviz_pca_ind(passenger.pca, geom.ind = "point", pointshape = 21, 
             pointsize = 2, 
             fill.ind = passenger.data$satisfaction, 
             col.ind = "black", 
             palette = "jco", 
             addEllipses = TRUE,
             label = "var",
             col.var = "black",
             repel = TRUE,
             legend.title = "Satisfaction") +
  ggtitle("2D PCA-plot from 23 feature dataset") +
  theme(plot.title = element_text(hjust = 0.5))
#From the above summary and graphs of the PCs, we see a low level of variance in the features, and reducing the
#dimension will not significantly increase the efficiency of the models. 
#Hence I will not go ahead and implement PCA for this dataset.

#Creating a function for normalization
normalize <- function(x)
  {
    return ((x-min(x))/(max(x)-min(x)))
  }

#Normalized passenger data
passenger.data <- data.frame(lapply(passenger.data[,-23], normalize), passenger.data$satisfaction)
colnames(passenger.data)[23] <- "satisfaction"

str(passenger.data)
```

4. Model Construction and Evaluation

```{r warning=F, message=F}
#Importing libraries
library(caret)
library(e1071)
library(neuralnet)
library(class)

#Creating a random sample using createDataPartition function
set.seed(1)
sample <- createDataPartition(passenger.data$satisfaction, p=0.75, list = FALSE)

#Creating a training and testing dataset based on the sampled value
train.data <- passenger.data[sample,]
test.data <- passenger.data[-sample,]

###kNN###

#Creating train labels and test labels for kNN implementation
train.label <- train.data[,23]
test.label <- test.data[,23]

Sys.time()
#Creating kNN model
kNN.predict <- knn(train = train.data[,-23], test = test.data[,-23], cl = train.label, k = 5)

#Producing Confusion matrix for the classification
confusionMatrix(kNN.predict, test.label)
Sys.time()

###SVM###

Sys.time()
#Creating SVM model
passenger.SVM <- svm(satisfaction ~ ., data = train.data, probability = TRUE)

Sys.time()
#Predicting the values for the test data
SVM.predict <- predict(passenger.SVM, test.data, probability = TRUE)

#Printing the confusionMatrix for the SVM model
confusionMatrix(SVM.predict, test.data$satisfaction)
Sys.time()

###Neural Network###

#Creating training and testing datasets for Neural Netwrok(NN)
NN.train <- train.data
NN.test <- test.data

#Setting y as an integer
NN.train$satisfaction <- as.integer(NN.train$satisfaction)
NN.test$satisfaction <- as.integer(NN.test$satisfaction)

#Creating function softplus for smoothening
softplus <- function(x) log(1+exp(x))

Sys.time()
#Creating Neural Network model
passenger.NN <- neuralnet(satisfaction ~ ., NN.train, hidden = c(3, 2), threshold = 0.5, rep = 1, linear.output = FALSE, act.fct = softplus)
nn.end <- Sys.time()

#plotting the neural network graph
plot(passenger.NN, rep="best")

Sys.time()
#Computing the values for the test data
NN.predict <- compute(passenger.NN, NN.test[,-23])

#Calculating correlation between the actual and predicted values
cor.NN <- cor(NN.predict$net.result, NN.test$satisfaction)
sprintf("The correlation between actual values and predicted values by Neural Network is: %s", cor.NN)
Sys.time()
```

